<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internship Application Tracker</title>
    
    <style>
      :root {
        --bg: #0c0300;
        --bg-overlay: rgba(7, 0, 0, 0.7);
        --card: rgba(20, 6, 2, 0.9);
        --card-soft: rgba(255, 255, 255, 0.08);
        --text: #fff6e8;
        --muted: #f6c7a2;
        --border: rgba(255, 255, 255, 0.15);
        --accent: #ffb347;
        --accent-strong: #ff6f3c;
        --accent-soft: rgba(255, 152, 74, 0.25);
        --shadow: 0 20px 50px rgba(0, 0, 0, 0.55);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: url("./fire.png") center/cover no-repeat;
        filter: blur(14px) saturate(1.3) brightness(0.9);
        z-index: -2;
      }

      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 140, 66, 0.25), rgba(0, 0, 0, 0.85));
        z-index: -1;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
        position: relative;
      }

      header {
        margin-bottom: 2rem;
        padding: 2rem;
        border-radius: 24px;
        background: var(--bg-overlay);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .countdown-banner {
        margin: 1.5rem 0 0;
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: linear-gradient(135deg, rgba(255, 0, 0, 0.25), rgba(0, 0, 0, 0.7));
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
        position: relative;
        overflow: hidden;
      }

      .countdown-banner::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.12) 0, rgba(255, 255, 255, 0.12) 10px, transparent 10px, transparent 20px);
        opacity: 0.2;
      }

      .countdown-banner h2 {
        margin: 0;
        font-size: 1.75rem;
        color: #ffe4e4;
      }

      .countdown-banner p {
        margin: 0.35rem 0 0;
        font-size: 1rem;
        color: #ff9f9f;
      }

      .countdown-number {
        font-size: clamp(2.5rem, 6vw, 4rem);
        font-weight: 800;
        color: #ff4d4d;
        text-shadow: 0 0 12px rgba(255, 77, 77, 0.7);
      }

      h1 {
        margin: 0 0 0.3rem;
        font-size: clamp(2rem, 4vw, 3.2rem);
      }

      .lead {
        margin: 0;
        font-size: 1.05rem;
        color: var(--muted);
      }

      .team-total {
        margin-top: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
      }

      .sync-status {
        margin: 0.35rem 0 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .sync-status[data-variant="success"] {
        color: #84f197;
      }

      .sync-status[data-variant="error"] {
        color: #ffc1c1;
      }

      .hero-media {
        margin: 1.5rem auto 0;
        border-radius: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.12);
        max-width: 500px;
      }

      .hero-media img {
        display: block;
        width: 100%;
        height: auto;
      }

      .audio-block {
        margin: 1.5rem 0 0;
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.35);
        box-shadow: var(--shadow);
      }

      .audio-block label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.35rem;
      }

      audio {
        width: 100%;
        outline: none;
      }

      .auth-section[hidden],
      .tracker-shell[hidden] {
        display: none;
      }

      .auth-section {
        margin-top: 2rem;
      }

      .auth-card {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
        padding: 2rem;
        border-radius: 24px;
        background: var(--bg-overlay);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow);
      }

      .auth-card h2 {
        margin: 0 0 0.75rem;
      }

      .auth-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .auth-form label {
        font-size: 0.9rem;
        color: var(--muted);
        display: block;
      }

      .auth-form input {
        width: 100%;
        margin-top: 0.25rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.65rem;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.35);
        color: var(--text);
      }

      .auth-form button {
        margin-top: 0.5rem;
      }

      .auth-error {
        min-height: 1.1rem;
        font-size: 0.85rem;
        color: #ffd5d5;
        margin-top: 0.35rem;
      }

      .tracker-shell {
        margin-top: 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .tracker-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        border-radius: 16px;
        background: var(--bg-overlay);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: var(--shadow);
      }

      .welcome-text {
        margin: 0;
        color: var(--muted);
      }

      .tracker-feed {
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
      }

      .person-block {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .person-card,
      .stat-card {
        background: var(--card);
        border-radius: 1.25rem;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(6px);
      }

      .person-card header {
        margin-bottom: 1rem;
      }

      .person-card h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      .count-label {
        margin: 0.25rem 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .count {
        font-size: 2.4rem;
        font-weight: 700;
        margin: 0.15rem 0 0;
      }

      .input-stack {
        margin: 1rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .input-block label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.35rem;
        color: var(--muted);
      }

      .input-block input {
        width: 100%;
        padding: 0.65rem 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 0.6rem;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
      }

      .input-block input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .input-block input.has-error {
        border-color: #ff8a8a;
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.25);
      }

      .input-error {
        color: #ffd5d5;
        font-size: 0.85rem;
        margin: 0.35rem 0 0;
        display: none;
      }

      .input-error.is-visible {
        display: block;
      }

      button {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.8rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        color: #1b0500;
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 25px rgba(255, 138, 80, 0.4);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .logout-btn {
        width: auto;
        padding: 0.55rem 1.5rem;
        color: var(--text);
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .company-list {
        list-style: none;
        padding: 0;
        margin: 1rem 0 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .company-list li {
        padding: 0.65rem 0.75rem;
        border-radius: 0.65rem;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .company-entry {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: baseline;
      }

      .company-name {
        font-weight: 600;
      }

      .company-country,
      .company-date {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .company-list li.empty {
        justify-content: center;
        color: var(--muted);
        font-style: italic;
      }

      .stats-panel {
        border-radius: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.35);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .stats-panel summary {
        list-style: none;
        cursor: pointer;
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        font-weight: 600;
      }

      .stats-panel summary::-webkit-details-marker {
        display: none;
      }

      .stats-panel summary span:last-child {
        font-size: 0.9rem;
        color: var(--muted);
        font-weight: 500;
      }

      .stats-panel[open] summary {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
      }

      .stats-content {
        padding: 0 1.25rem 1.25rem;
      }

      .stat-line {
        display: flex;
        justify-content: space-between;
        margin: 0.2rem 0;
      }

      .stat-line span:last-child {
        font-weight: 600;
      }

      .histogram {
        margin-top: 0.9rem;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .histogram-heading {
        margin: 0.85rem 0 0;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .histogram-row {
        display: grid;
        grid-template-columns: minmax(0, 42%) minmax(0, 1fr) auto;
        gap: 0.5rem;
        align-items: center;
      }

      .histogram-label {
        font-size: 0.85rem;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .histogram-bar-wrapper {
        position: relative;
        height: 0.45rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        overflow: hidden;
      }

      .histogram-bar {
        display: block;
        height: 100%;
        border-radius: inherit;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong));
        transition: width 0.2s ease;
      }

      .histogram-count {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text);
        text-align: right;
      }

      .histogram-empty {
        font-size: 0.85rem;
        color: var(--muted);
        font-style: italic;
      }

      .person-card.is-locked .input-stack,
      .person-card.is-locked button {
        opacity: 0.35;
        pointer-events: none;
      }

      .person-card.is-locked .lock-note {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .empty-feed {
        padding: 2rem;
        text-align: center;
        border-radius: 1rem;
        background: rgba(0, 0, 0, 0.35);
        border: 1px dashed rgba(255, 255, 255, 0.2);
      }

      @media (min-width: 900px) {
        .hero-media {
          max-width: 280px;
          margin-left: 0;
          margin-right: 0;
        }
      }
    </style>

  </head>
  <body>
    <main>
      <header>
        <h1>Dfi3 Competitive ÿØŸÅŸäÿπ ÿßŸÑÿ±ÿ≠ŸÖÿ© üî•</h1>
        <p class="lead">Track the hustle between Europe wanna-goers. Log applications, keep tabs on company lists, and see who is leading.</p>
        <p class="team-total">Team total: <span data-role="team-total">0</span> applications</p>
        <p class="sync-status" data-role="sync-status">Syncing latest data‚Ä¶</p>
        <figure class="hero-media">
          <img src="./image.png" alt="Team snapshot for the internship race tracker" loading="lazy" />
        </figure>
        <div class="audio-block">
          <label for="anthem-audio">Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑŸÜŸáÿßŸäÿ©...ÿßÿ≠ÿ®ÿ≥ ŸÜŸÅŸéÿ≥ŸÉ Ÿà ÿπŸèÿØŸëŸé ÿ≠ÿ™Ÿâ ÿπÿ¥ÿ±ÿ©</label>
          <audio id="anthem-audio" controls preload="none">
            <source src="./skyfall.mp3" type="audio/mpeg" />
            Your browser does not support the audio element.
          </audio>
        </div>
        <div class="countdown-banner">
          <h2>‚è≥ <span class="countdown-number" data-role="days-left">0</span> days left</h2>
          <p>If you don‚Äôt land an internship before January 1st, you‚Äôll be stuck in Morocco forever. Move.</p>
        </div>
      </header>

      <section class="auth-section" data-role="auth-screen">
        <div class="auth-card">
          <div>
            <h2>Sign in</h2>
            <form class="auth-form" data-role="login-form">
              <label>
                Username
                <input type="text" name="username" autocomplete="username" required />
              </label>
              <label>
                Password
                <input type="password" name="password" autocomplete="current-password" required />
              </label>
              <button type="submit">Log in</button>
            </form>
            <p class="auth-error" data-role="login-error"></p>
          </div>
          <div>
            <h2>Create account</h2>
            <form class="auth-form" data-role="register-form">
              <label>
                First name
                <input type="text" name="firstName" autocomplete="given-name" required />
              </label>
              <label>
                Family name
                <input type="text" name="lastName" autocomplete="family-name" required />
              </label>
              <label>
                Username
                <input type="text" name="username" autocomplete="username" required />
              </label>
              <label>
                Password
                <input type="password" name="password" autocomplete="new-password" required />
              </label>
              <button type="submit">Create account</button>
            </form>
            <p class="auth-error" data-role="register-error"></p>
          </div>
        </div>
      </section>

      <section class="tracker-shell" data-role="tracker-screen" hidden>
        <div class="tracker-actions">
          <p class="welcome-text">
            Signed in as <strong data-role="current-user-name">‚Äî</strong>
          </p>
          <button type="button" class="logout-btn" data-role="logout-btn">Log out</button>
        </div>
        <section class="tracker-feed" data-role="tracker-feed">
          <p class="empty-feed">Loading teammates‚Ä¶</p>
        </section>
      </section>
    </main>

    
    <script>
      (() => {
        const API = {
          state: "/api/state",
          log: "/api/log",
          login: "/api/auth/login",
          register: "/api/auth/register",
          me: "/api/auth/me",
        };

        const STORAGE_KEYS = {
          auth: "tracker.auth",
        };

        const state = {
          auth: loadStoredAuth(),
          people: [],
          peopleMap: {},
          cardRefs: {},
          statRefs: {},
        };

        const els = {
          teamTotal: document.querySelector('[data-role="team-total"]'),
          syncStatus: document.querySelector('[data-role="sync-status"]'),
          authScreen: document.querySelector('[data-role="auth-screen"]'),
          trackerScreen: document.querySelector('[data-role="tracker-screen"]'),
          loginForm: document.querySelector('[data-role="login-form"]'),
          registerForm: document.querySelector('[data-role="register-form"]'),
          loginError: document.querySelector('[data-role="login-error"]'),
          registerError: document.querySelector('[data-role="register-error"]'),
          logoutBtn: document.querySelector('[data-role="logout-btn"]'),
          currentUserName: document.querySelector('[data-role="current-user-name"]'),
          trackerFeed: document.querySelector('[data-role="tracker-feed"]'),
        };

        init();

        function init() {
          initForms();
          bootstrap();
          startCountdown();
        }

        async function bootstrap() {
          if (state.auth.token) {
            await refreshSession();
          }
          updateScreens();
          if (state.auth.user) {
            await refreshFromServer();
          } else {
            setSyncStatus("Sign in to access the tracker", "error");
          }
        }

        function initForms() {
          els.loginForm?.addEventListener("submit", handleLoginSubmit);
          els.registerForm?.addEventListener("submit", handleRegisterSubmit);
          els.logoutBtn?.addEventListener("click", handleLogout);
        }

        async function handleLoginSubmit(event) {
          event.preventDefault();
          if (!els.loginForm) return;
          clearErrorMessage(els.loginError);
          const formData = new FormData(els.loginForm);
          const payload = {
            username: String(formData.get("username") || "").trim(),
            password: String(formData.get("password") || "").trim(),
          };
          if (!payload.username || !payload.password) {
            setErrorMessage(els.loginError, "Enter your username and password");
            return;
          }
          const button = els.loginForm.querySelector("button[type=submit]");
          if (button) button.disabled = true;
          try {
            const response = await fetchJson(API.login, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            setAuth(response);
            els.loginForm.reset();
            await refreshFromServer();
          } catch (error) {
            setErrorMessage(els.loginError, error.message);
          } finally {
            if (button) button.disabled = false;
          }
        }

        async function handleRegisterSubmit(event) {
          event.preventDefault();
          if (!els.registerForm) return;
          clearErrorMessage(els.registerError);
          const formData = new FormData(els.registerForm);
          const payload = {
            firstName: String(formData.get("firstName") || "").trim(),
            lastName: String(formData.get("lastName") || "").trim(),
            username: String(formData.get("username") || "").trim(),
            password: String(formData.get("password") || "").trim(),
          };
          if (!payload.firstName || !payload.lastName || !payload.username || !payload.password) {
            setErrorMessage(els.registerError, "Fill out every field");
            return;
          }
          const button = els.registerForm.querySelector("button[type=submit]");
          if (button) button.disabled = true;
          try {
            const response = await fetchJson(API.register, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            setAuth(response);
            els.registerForm.reset();
            await refreshFromServer();
          } catch (error) {
            setErrorMessage(els.registerError, error.message);
          } finally {
            if (button) button.disabled = false;
          }
        }

        function handleLogout() {
          clearAuth();
          updateScreens();
          state.people = [];
          renderPeople();
          setSyncStatus("Signed out", "info");
        }

        async function refreshSession() {
          try {
            const response = await fetchJson(API.me, { auth: true });
            setAuth({ token: state.auth.token, user: response.user });
          } catch (error) {
            clearAuth();
            console.warn("Session check failed", error);
          }
        }

        async function refreshFromServer() {
          if (!state.auth.user) {
            return;
          }
          setSyncStatus("Syncing latest data‚Ä¶", "info");
          try {
            const payload = await fetchJson(API.state);
            setPeople(payload.people ?? []);
            renderPeople();
            updateTeamTotal(payload.teamTotal ?? 0);
            setSyncStatus("Up to date", "success");
          } catch (error) {
            console.warn("Unable to sync from server", error);
            setSyncStatus("Unable to sync data right now", "error");
          }
        }

        function setPeople(list) {
          state.people = (Array.isArray(list) ? list : []).sort((a, b) => (b.count ?? 0) - (a.count ?? 0));
          state.peopleMap = state.people.reduce((acc, person) => {
            acc[person.id] = person;
            return acc;
          }, {});
        }

        function renderPeople() {
          if (!els.trackerFeed) return;
          els.trackerFeed.innerHTML = "";
          state.cardRefs = {};
          state.statRefs = {};
          if (!state.people.length) {
            const empty = document.createElement("p");
            empty.className = "empty-feed";
            empty.textContent = state.auth.user ? "No teammates yet" : "Sign in to view feeds";
            els.trackerFeed.appendChild(empty);
            updateTeamTotal(0);
            return;
          }
          state.people.forEach((person) => {
            const block = buildPersonBlock(person);
            els.trackerFeed.appendChild(block);
          });
          state.people.forEach((person) => {
            updatePersonCard(person.id);
          });
          updateStats();
        }

        function buildPersonBlock(person) {
          const isOwner = state.auth.user?.personId === person.id;
          const block = document.createElement("article");
          block.className = "person-block";
          block.dataset.person = person.id;

          const card = document.createElement("div");
          card.className = "person-card";
          if (!isOwner) {
            card.classList.add("is-locked");
          }

          const header = document.createElement("header");
          const title = document.createElement("h2");
          title.textContent = person.displayName;
          const label = document.createElement("p");
          label.className = "count-label";
          label.textContent = "Applications logged";
          const countEl = document.createElement("p");
          countEl.className = "count";
          countEl.dataset.role = "count";
          countEl.textContent = "0";
          header.append(title, label, countEl);
          card.appendChild(header);

          let companyInputEl = null;
          let countryInputEl = null;
          let errorEl = null;
          let buttonEl = null;

          if (isOwner) {
            const stack = document.createElement("div");
            stack.className = "input-stack";

            const companyBlock = document.createElement("div");
            companyBlock.className = "input-block";
            const companyLabel = document.createElement("label");
            companyLabel.textContent = "Company name";
            companyInputEl = document.createElement("input");
            companyInputEl.type = "text";
            companyInputEl.placeholder = "e.g., SunCore Labs";
            companyInputEl.autocomplete = "off";
            companyInputEl.dataset.role = "company-input";
            companyLabel.appendChild(companyInputEl);
            companyBlock.appendChild(companyLabel);

            const countryBlock = document.createElement("div");
            countryBlock.className = "input-block";
            const countryLabel = document.createElement("label");
            countryLabel.textContent = "Country";
            countryInputEl = document.createElement("input");
            countryInputEl.type = "text";
            countryInputEl.placeholder = "e.g., Spain";
            countryInputEl.autocomplete = "off";
            countryInputEl.dataset.role = "country-input";
            countryLabel.appendChild(countryInputEl);
            countryBlock.appendChild(countryLabel);

            errorEl = document.createElement("p");
            errorEl.className = "input-error";
            errorEl.dataset.role = "input-error";
            errorEl.textContent = "Add both the company and country before logging.";

            stack.append(companyBlock, countryBlock, errorEl);
            card.appendChild(stack);

            buttonEl = document.createElement("button");
            buttonEl.type = "button";
            buttonEl.dataset.role = "add-btn";
            buttonEl.textContent = "Add application";
            buttonEl.addEventListener("click", () => logApplication(person.id));

            const handleInput = (field) => () => clearError(person.id, field);
            companyInputEl.addEventListener("input", handleInput("company"));
            countryInputEl.addEventListener("input", handleInput("country"));
            [companyInputEl, countryInputEl].forEach((inputEl) => {
              inputEl.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                  event.preventDefault();
                  logApplication(person.id);
                }
              });
            });

            card.appendChild(buttonEl);
          } else {
            const note = document.createElement("p");
            note.className = "lock-note";
            note.textContent = `Only ${person.displayName} can log here.`;
            card.appendChild(note);
          }

          const listEl = document.createElement("ul");
          listEl.className = "company-list";
          listEl.dataset.role = "company-list";
          const emptyItem = document.createElement("li");
          emptyItem.className = "empty";
          emptyItem.textContent = "No applications yet";
          listEl.appendChild(emptyItem);
          card.appendChild(listEl);

          block.appendChild(card);

          const statsPanel = document.createElement("details");
          statsPanel.className = "stats-panel";
          const summary = document.createElement("summary");
          const summaryLabel = document.createElement("span");
          summaryLabel.textContent = `Stats for ${person.displayName}`;
          const summaryValue = document.createElement("span");
          summaryValue.dataset.role = "stat-summary";
          summaryValue.textContent = "0 apps ¬∑ 0%";
          summary.append(summaryLabel, summaryValue);
          statsPanel.appendChild(summary);

          const statsContent = document.createElement("div");
          statsContent.className = "stats-content";
          const statCard = document.createElement("div");
          statCard.className = "stat-card";

          const totalLine = createStatLine("Total logged");
          const shareLine = createStatLine("Share of total");
          const latestLine = createStatLine("Latest application");
          const totalValue = totalLine.querySelector("span:last-child");
          const shareValue = shareLine.querySelector("span:last-child");
          const latestValue = latestLine.querySelector("span:last-child");
          shareValue.textContent = "0%";
          latestValue.textContent = "‚Äî";

          const histHeading = document.createElement("p");
          histHeading.className = "histogram-heading";
          histHeading.textContent = "Top countries";

          const histogramEl = document.createElement("div");
          histogramEl.className = "histogram";
          const histogramEmpty = document.createElement("p");
          histogramEmpty.className = "histogram-empty";
          histogramEmpty.textContent = "No countries yet";
          histogramEl.appendChild(histogramEmpty);

          statCard.append(totalLine, shareLine, latestLine, histHeading, histogramEl);
          statsContent.appendChild(statCard);
          statsPanel.appendChild(statsContent);
          block.appendChild(statsPanel);

          state.cardRefs[person.id] = {
            countEl,
            companyInputEl,
            countryInputEl,
            errorEl,
            buttonEl,
            listEl,
          };

          state.statRefs[person.id] = {
            summaryEl: summaryValue,
            totalEl: totalValue,
            shareEl: shareValue,
            latestEl: latestValue,
            histogramEl,
          };

          return block;
        }

        function createStatLine(label) {
          const p = document.createElement("p");
          p.className = "stat-line";
          const left = document.createElement("span");
          left.textContent = label;
          const right = document.createElement("span");
          right.textContent = "0";
          p.append(left, right);
          return p;
        }

        function updatePersonCard(personId) {
          const person = state.peopleMap[personId];
          const refs = state.cardRefs[personId];
          if (!person || !refs) return;
          refs.countEl.textContent = person.count ?? 0;
          refs.listEl.innerHTML = "";
          const entries = Array.isArray(person.applications) ? person.applications : [];
          if (!entries.length) {
            const empty = document.createElement("li");
            empty.className = "empty";
            empty.textContent = "No applications yet";
            refs.listEl.appendChild(empty);
            return;
          }
          entries.slice(0, 5).forEach((entry) => {
            const li = document.createElement("li");
            const row = document.createElement("div");
            row.className = "company-entry";
            const companySpan = document.createElement("span");
            companySpan.className = "company-name";
            companySpan.textContent = entry.company;
            const countrySpan = document.createElement("span");
            countrySpan.className = "company-country";
            countrySpan.textContent = entry.country;
            const timestampSpan = document.createElement("span");
            timestampSpan.className = "company-date";
            timestampSpan.textContent = formatTimestamp(entry.timestamp);
            row.append(companySpan, countrySpan);
            li.append(row, timestampSpan);
            refs.listEl.appendChild(li);
          });
        }

        function updateStats() {
          const teamTotal = state.people.reduce((sum, person) => sum + (person.count ?? 0), 0);
          updateTeamTotal(teamTotal);
          state.people.forEach((person) => {
            const refs = state.statRefs[person.id];
            if (!refs) return;
            const share = teamTotal ? Math.round((person.count / teamTotal) * 100) : 0;
            refs.totalEl.textContent = person.count ?? 0;
            refs.shareEl.textContent = `${share}%`;
            refs.summaryEl.textContent = `${person.count ?? 0} ${(person.count ?? 0) === 1 ? "app" : "apps"} ¬∑ ${share}%`;
            const latest = person.applications?.[0];
            refs.latestEl.textContent = latest ? `${latest.company} (${latest.country})` : "‚Äî";
            renderHistogram(person.id);
          });
        }

        function renderHistogram(personId) {
          const refs = state.statRefs[personId];
          const person = state.peopleMap[personId];
          if (!refs || !person) return;
          const histogramEl = refs.histogramEl;
          histogramEl.innerHTML = "";
          const entries = Array.isArray(person.applications) ? person.applications : [];
          if (!entries.length) {
            const empty = document.createElement("p");
            empty.className = "histogram-empty";
            empty.textContent = "No countries yet";
            histogramEl.appendChild(empty);
            return;
          }
          const counts = entries.reduce((acc, entry) => {
            const key = entry.country || "Unknown";
            acc[key] = (acc[key] || 0) + 1;
            return acc;
          }, {});
          const rows = Object.entries(counts)
            .map(([country, count]) => ({ country, count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 6);
          const maxCount = rows[0]?.count ?? 1;
          rows.forEach((item) => {
            const row = document.createElement("div");
            row.className = "histogram-row";
            const label = document.createElement("span");
            label.className = "histogram-label";
            label.textContent = item.country;
            const barWrapper = document.createElement("div");
            barWrapper.className = "histogram-bar-wrapper";
            const bar = document.createElement("span");
            bar.className = "histogram-bar";
            bar.style.width = `${Math.max((item.count / maxCount) * 100, 6)}%`;
            barWrapper.appendChild(bar);
            const countEl = document.createElement("span");
            countEl.className = "histogram-count";
            countEl.textContent = item.count;
            row.append(label, barWrapper, countEl);
            histogramEl.appendChild(row);
          });
        }

        function updateTeamTotal(value) {
          if (!els.teamTotal) return;
          els.teamTotal.textContent = value;
        }

        function setSyncStatus(message, variant = "info") {
          if (!els.syncStatus) return;
          els.syncStatus.textContent = message;
          els.syncStatus.dataset.variant = variant;
        }

        function startCountdown() {
          const target = new Date("2026-01-01T00:00:00Z");
          const label = document.querySelector('[data-role="days-left"]');
          if (!label) return;
          const update = () => {
            const now = new Date();
            const diff = target - now;
            const days = Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
            label.textContent = days;
          };
          update();
          setInterval(update, 1000 * 60 * 60);
        }

        function showError(personId, missing) {
          const refs = state.cardRefs[personId];
          if (!refs) return;
          if (missing.company && refs.companyInputEl) {
            refs.companyInputEl.classList.add("has-error");
            refs.companyInputEl.focus();
          }
          if (missing.country && refs.countryInputEl) {
            refs.countryInputEl.classList.add("has-error");
            if (!missing.company) refs.countryInputEl.focus();
          }
          refs.errorEl?.classList.add("is-visible");
        }

        function clearError(personId, field) {
          const refs = state.cardRefs[personId];
          if (!refs) return;
          if ((!field || field === "company") && refs.companyInputEl) {
            refs.companyInputEl.classList.remove("has-error");
          }
          if ((!field || field === "country") && refs.countryInputEl) {
            refs.countryInputEl.classList.remove("has-error");
          }
          if (
            refs.errorEl &&
            (!refs.companyInputEl || !refs.companyInputEl.classList.contains("has-error")) &&
            (!refs.countryInputEl || !refs.countryInputEl.classList.contains("has-error"))
          ) {
            refs.errorEl.classList.remove("is-visible");
          }
        }

        async function logApplication(personId) {
          if (!state.auth.user || !state.auth.token) {
            setSyncStatus("Please sign in to log applications", "error");
            return;
          }
          if (state.auth.user.personId !== personId) {
            setSyncStatus("You can only update your own board", "error");
            return;
          }
          const refs = state.cardRefs[personId];
          if (!refs || !refs.companyInputEl || !refs.countryInputEl) {
            return;
          }
          const company = refs.companyInputEl.value.trim();
          const country = refs.countryInputEl.value.trim();
          const missing = {
            company: !company,
            country: !country,
          };
          if (missing.company || missing.country) {
            showError(personId, missing);
            return;
          }
          setButtonLoading(refs, true);
          setSyncStatus("Saving application‚Ä¶", "info");
          try {
            const payload = await fetchJson(API.log, {
              method: "POST",
              headers: authHeaders({ "Content-Type": "application/json" }),
              body: JSON.stringify({ company, country }),
            });
            refs.companyInputEl.value = "";
            refs.countryInputEl.value = "";
            clearError(personId);
            setPeople(payload.people ?? []);
            renderPeople();
            updateTeamTotal(payload.teamTotal ?? 0);
            setSyncStatus("Synced just now", "success");
          } catch (error) {
            console.error("Unable to log application", error);
            setSyncStatus(error.message || "Could not save. Try again.", "error");
          } finally {
            setButtonLoading(refs, false);
          }
        }

        function setButtonLoading(refs, isLoading) {
          if (!refs?.buttonEl) return;
          refs.buttonEl.disabled = isLoading;
        }

        function setAuth(next) {
          if (!next) return;
          state.auth = {
            token: next.token,
            user: next.user,
          };
          saveAuth();
          updateScreens();
        }

        function clearAuth() {
          state.auth = { token: null, user: null };
          saveAuth();
        }

        function saveAuth() {
          try {
            if (state.auth.token) {
              localStorage.setItem(STORAGE_KEYS.auth, JSON.stringify(state.auth));
            } else {
              localStorage.removeItem(STORAGE_KEYS.auth);
            }
          } catch {
            // ignore storage failures
          }
        }

        function loadStoredAuth() {
          try {
            const raw = localStorage.getItem(STORAGE_KEYS.auth);
            if (!raw) return { token: null, user: null };
            const parsed = JSON.parse(raw);
            return {
              token: parsed.token ?? null,
              user: parsed.user ?? null,
            };
          } catch {
            return { token: null, user: null };
          }
        }

        function updateScreens() {
          if (state.auth.user) {
            if (els.authScreen) els.authScreen.hidden = true;
            if (els.trackerScreen) els.trackerScreen.hidden = false;
            if (els.currentUserName) {
              els.currentUserName.textContent = state.auth.user.displayName || state.auth.user.username;
            }
          } else {
            if (els.authScreen) els.authScreen.hidden = false;
            if (els.trackerScreen) els.trackerScreen.hidden = true;
            if (els.currentUserName) els.currentUserName.textContent = "‚Äî";
          }
        }

        function setErrorMessage(target, message) {
          if (!target) return;
          target.textContent = message;
        }

        function clearErrorMessage(target) {
          if (!target) return;
          target.textContent = "";
        }

        function formatTimestamp(value) {
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) {
            return "Unknown";
          }
          return date.toLocaleString(undefined, {
            month: "short",
            day: "numeric",
            hour: "numeric",
            minute: "2-digit",
          });
        }

        function authHeaders(base = {}) {
          const headers = { ...base };
          if (state.auth.token) {
            headers.Authorization = `Bearer ${state.auth.token}`;
          }
          return headers;
        }

        async function fetchJson(url, options = {}) {
          const config = {
            method: options.method ?? "GET",
            headers: {
              Accept: "application/json",
              ...(options.headers || {}),
            },
            body: options.body,
          };
          if (options.auth) {
            config.headers = authHeaders(config.headers);
          }
          const response = await fetch(url, config);
          const contentType = response.headers.get("content-type") || "";
          const isJson = contentType.includes("application/json");
          const payload = isJson ? await response.json() : await response.text();
          if (!response.ok) {
            const message = typeof payload === "object" && payload?.error ? payload.error : `Request failed (${response.status})`;
            throw new Error(message);
          }
          return payload;
        }
      })();
    </script>

  </body>
</html>
